<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X·ªï S·ªë Tr·ª±c Tuy·∫øn - XSHCM & XSMB</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé∞</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #e74c3c;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .time-display {
            margin-top: 15px;
            font-size: 24px;
            font-family: 'Courier New', monospace;
        }

        .time-display .date {
            font-size: 16px;
            opacity: 0.8;
        }

        .update-info {
            margin-top: 10px;
            font-size: 14px;
            opacity: 0.7;
        }

        .countdown {
            margin-top: 10px;
            padding: 10px 20px;
            background: rgba(46, 204, 113, 0.3);
            border-radius: 10px;
            display: inline-block;
        }

        /* Lottery Section */
        .lottery-section {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 30px;
        }

        .lottery-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
            flex: 1;
            min-width: 380px;
            max-width: 550px;
            color: #333;
            transition: transform 0.3s;
        }

        .lottery-card:hover {
            transform: translateY(-5px);
        }

        .lottery-card.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lottery-header {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
        }

        .lottery-header.north {
            background: linear-gradient(90deg, #3498db, #2980b9);
        }

        .lottery-header h2 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .lottery-header .date {
            font-size: 14px;
            opacity: 0.9;
        }

        .lottery-header .status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.3);
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 12px;
        }

        .lottery-table {
            width: 100%;
            border-collapse: collapse;
        }

        .lottery-table th,
        .lottery-table td {
            padding: 12px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }

        .lottery-table th {
            background: #f8f9fa;
            color: #333;
            font-weight: bold;
            width: 100px;
        }

        .lottery-table td {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .lottery-table .special {
            background: linear-gradient(90deg, #fff3cd, #ffeeba);
        }

        .lottery-table .special td {
            color: #e74c3c;
            font-size: 28px;
        }

        .numbers {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }

        .numbers span {
            background: linear-gradient(145deg, #f5f5f5, #e8e8e8);
            padding: 5px 12px;
            border-radius: 8px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .numbers span:hover {
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.1);
        }

        .numbers span.highlight {
            background: #2ecc71 !important;
            color: white !important;
            animation: pop 0.5s ease;
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* Check Section */
        .check-section {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 700px;
            margin: 0 auto 30px;
            color: #333;
        }

        .check-section h3 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group input {
            flex: 1;
            padding: 18px;
            font-size: 24px;
            border: 3px solid #ddd;
            border-radius: 12px;
            text-align: center;
            letter-spacing: 8px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
        }

        .region-select {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .region-select label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 12px 25px;
            border: 2px solid #ddd;
            border-radius: 12px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .region-select label:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .region-select input[type="radio"] {
            width: 18px;
            height: 18px;
        }

        .region-select label:has(input:checked) {
            border-color: #667eea;
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
        }

        .check-btn {
            width: 100%;
            padding: 18px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .check-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .check-btn:active {
            transform: translateY(0);
        }

        .note {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(90deg, #fff3cd, #ffeeba);
            border-radius: 10px;
            font-size: 14px;
            color: #856404;
            border-left: 4px solid #f39c12;
        }

        .note strong {
            color: #e74c3c;
        }

        /* Result Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            max-width: 550px;
            width: 90%;
            animation: slideIn 0.4s ease;
            color: #333;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .modal-content.win {
            border: 5px solid #28a745;
            box-shadow: 0 0 50px rgba(40, 167, 69, 0.5);
        }

        .modal-content.lose {
            border: 5px solid #ffc107;
        }

        .modal-content h2 {
            font-size: 28px;
            margin-bottom: 15px;
        }

        .modal-content.win h2 {
            color: #28a745;
        }

        .modal-content.lose h2 {
            color: #856404;
        }

        .modal-content p {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .modal-content .prize-info {
            background: linear-gradient(145deg, #d4edda, #c3e6cb);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 18px;
            color: #155724;
        }

        .modal-content .agency-note {
            background: linear-gradient(145deg, #cce5ff, #b8daff);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 14px;
            color: #004085;
            line-height: 1.8;
        }

        .close-btn {
            padding: 15px 50px;
            font-size: 18px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .close-btn:hover {
            transform: scale(1.05);
        }

        .emoji {
            font-size: 80px;
            margin-bottom: 15px;
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            animation: fall 3s linear forwards;
            z-index: 1001;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(720deg);
            }
        }

        /* Refresh button */
        .refresh-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: white;
            color: #1a1a2e;
        }

        .refresh-btn.loading {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            opacity: 0.7;
            font-size: 14px;
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-msg {
            color: #e74c3c;
            padding: 20px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .lottery-card {
                min-width: 100%;
            }
            
            .input-group {
                flex-direction: column;
            }

            .region-select {
                flex-direction: column;
                align-items: center;
            }

            .header h1 {
                font-size: 24px;
            }

            .input-group input {
                font-size: 20px;
                letter-spacing: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üé∞ K·∫æT QU·∫¢ X·ªî S·ªê TR·ª∞C TUY·∫æN üé∞</h1>
            <div class="live-indicator">
                <span class="live-dot"></span>
                LIVE - C·∫≠p nh·∫≠t tr·ª±c ti·∫øp
            </div>
            <div class="time-display">
                <div class="date" id="currentDate"></div>
                <div id="currentTime">--:--:--</div>
            </div>
            <div class="countdown" id="countdown">
                ‚è∞ ƒêang t·∫£i l·ªãch quay s·ªë...
            </div>
            <div class="update-info" id="updateInfo">
                C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: --:--:--
            </div>
            <button class="refresh-btn" onclick="refreshAllData()">üîÑ L√†m m·ªõi k·∫øt qu·∫£</button>
        </div>

        <!-- Check Section -->
        <div class="check-section">
            <h3>üîç D√í S·ªê TR·ª∞C TUY·∫æN</h3>
            <div class="region-select">
                <label>
                    <input type="radio" name="region" value="hcm" checked> üèôÔ∏è X·ªï s·ªë H·ªì Ch√≠ Minh
                </label>
                <label>
                    <input type="radio" name="region" value="mb"> üåÑ X·ªï s·ªë Mi·ªÅn B·∫Øc
                </label>
            </div>
            <div class="input-group">
                <input type="text" id="numberInput" maxlength="6" placeholder="Nh·∫≠p s·ªë (2-6 s·ªë)" 
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
            <button class="check-btn" onclick="checkNumber()">üéØ D√í S·ªê NGAY</button>
            <div class="note">
                <strong>üìå L∆∞u √Ω:</strong> Gi·∫£i An ·ª¶i - b·ªè con s·ªë ƒë·∫ßu ti√™n (S·ªë h√†ng trƒÉm ng√†n) v√† tr√πng ƒë·ªß <strong>5 s·ªë cu·ªëi c√πng</strong> li√™n ti·∫øp theo th·ª© t·ª± c·ªßa gi·∫£i ƒë·∫∑c bi·ªát.<br>
                üì° D·ªØ li·ªáu l·∫•y t·ª´ ngu·ªìn ch√≠nh th·ªëng: xskt.com.vn, xoso.com.vn, minhngoc.net.vn<br>
                üîÑ H·ªá th·ªëng t·ª± ƒë·ªông c·∫≠p nh·∫≠t k·∫øt qu·∫£ m·ªói 3 ph√∫t.
            </div>
        </div>

        <!-- Lottery Results -->
        <div class="lottery-section">
            <!-- HCM -->
            <div class="lottery-card" id="hcm-card">
                <div class="lottery-header">
                    <span class="status" id="hcm-status">üî¥ LIVE</span>
                    <h2>üèÜ X·ªî S·ªê H·ªí CH√ç MINH</h2>
                    <div class="date" id="hcm-date">ƒêang t·∫£i...</div>
                </div>
                <table class="lottery-table">
                    <tbody id="hcm-body">
                        <tr><td colspan="2"><div class="spinner"></div>ƒêang t·∫£i k·∫øt qu·∫£...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Mien Bac -->
            <div class="lottery-card" id="mb-card">
                <div class="lottery-header north">
                    <span class="status" id="mb-status">üî¥ LIVE</span>
                    <h2>üèÜ X·ªî S·ªê MI·ªÄN B·∫ÆC</h2>
                    <div class="date" id="mb-date">ƒêang t·∫£i...</div>
                </div>
                <table class="lottery-table">
                    <tbody id="mb-body">
                        <tr><td colspan="2"><div class="spinner"></div>ƒêang t·∫£i k·∫øt qu·∫£...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="footer">
            <p>üé∞ H·ªá th·ªëng x·ªï s·ªë tr·ª±c tuy·∫øn - C·∫≠p nh·∫≠t t·ª± ƒë·ªông m·ªói 3 ph√∫t</p>
            <p>üì° Ngu·ªìn d·ªØ li·ªáu: xskt.com.vn | xoso.com.vn | minhngoc.net.vn</p>
            <p>‚ö†Ô∏è K·∫øt qu·∫£ ch·ªâ mang t√≠nh ch·∫•t tham kh·∫£o</p>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal" id="resultModal">
        <div class="modal-content" id="modalContent">
            <div class="emoji" id="emoji">üéâ</div>
            <h2 id="resultTitle">Ch√∫c m·ª´ng!</h2>
            <p id="resultMessage"></p>
            <div class="prize-info" id="prizeInfo" style="display: none;"></div>
            <div class="agency-note" id="agencyNote" style="display: none;">
                üìç <strong>Vui l√≤ng mang v√© s·ªë ƒë·∫øn ƒë·∫°i l√Ω x·ªï s·ªë ho·∫∑c c√¥ng ty x·ªï s·ªë ki·∫øn thi·∫øt ƒë·ªÉ ƒë·ªïi th∆∞·ªüng!</strong><br><br>
                ‚è∞ Th·ªùi h·∫°n ƒë·ªïi th∆∞·ªüng: 30 ng√†y k·ªÉ t·ª´ ng√†y quay s·ªë.<br>
                üìû Hotline h·ªó tr·ª£: 1900-xxxx
            </div>
            <button class="close-btn" onclick="closeModal()">ƒê√≥ng</button>
        </div>
    </div>

    <script>
        // ==================== C·∫§U H√åNH ====================
        const CONFIG = {
            // C√°c CORS proxy ƒë·ªÉ bypass CORS policy (th·ª≠ l·∫ßn l∆∞·ª£t n·∫øu c√°i n√†o fail)
            CORS_PROXIES: [
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?',
                'https://api.codetabs.com/v1/proxy?quest='
            ],
            
            // C√°c ngu·ªìn x·ªï s·ªë ch√≠nh th·ªëng Vi·ªát Nam
            SOURCES: {
                hcm: [
                    'https://xskt.com.vn/xshcm-xstp',
                    'https://xoso.com.vn/xo-so-tphcm/xshcm-p1.html',
                    'https://www.minhngoc.net.vn/ket-qua-xo-so/mien-nam/tp-hcm.html'
                ],
                mb: [
                    'https://xskt.com.vn/xsmb',
                    'https://xoso.com.vn/xo-so-mien-bac.html',
                    'https://www.minhngoc.net.vn/ket-qua-xo-so/mien-bac.html'
                ]
            },
            
            // Th·ªùi gian c·∫≠p nh·∫≠t (3 ph√∫t)
            REFRESH_INTERVAL: 3 * 60 * 1000,
            
            // Gi·ªù quay s·ªë
            DRAW_TIMES: {
                hcm: { hour: 16, minute: 15 },
                mb: { hour: 18, minute: 15 }
            }
        };

        // ==================== D·ªÆ LI·ªÜU ====================
        let lotteryData = {
            hcm: null,
            mb: null,
            lastUpdate: null,
            source: null
        };

        const prizeLabels = {
            db: 'Gi·∫£i ƒêB',
            nhat: 'Gi·∫£i Nh·∫•t',
            nhi: 'Gi·∫£i Nh√¨',
            ba: 'Gi·∫£i Ba',
            tu: 'Gi·∫£i T∆∞',
            nam: 'Gi·∫£i NƒÉm',
            sau: 'Gi·∫£i S√°u',
            bay: 'Gi·∫£i B·∫£y',
            tam: 'Gi·∫£i T√°m'
        };

        const prizeAmounts = {
            db: '2.000.000.000 VNƒê',
            nhat: '30.000.000 VNƒê',
            nhi: '15.000.000 VNƒê',
            ba: '10.000.000 VNƒê',
            tu: '3.000.000 VNƒê',
            nam: '1.000.000 VNƒê',
            sau: '400.000 VNƒê',
            bay: '200.000 VNƒê',
            tam: '100.000 VNƒê',
            anui: '50.000.000 VNƒê'
        };

        // ==================== ƒê·ªíNG H·ªí ====================
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('vi-VN', { hour12: false });
            const dateStr = now.toLocaleDateString('vi-VN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('currentDate').textContent = dateStr;
            updateCountdown(now);
        }

        function updateCountdown(now) {
            const hour = now.getHours();
            const minute = now.getMinutes();
            
            let nextDraw = '';
            let timeLeft = '';
            
            // XSHCM quay l√∫c 16:15, XSMB quay l√∫c 18:15
            if (hour < 16 || (hour === 16 && minute < 15)) {
                const drawTime = new Date(now);
                drawTime.setHours(16, 15, 0);
                const diff = drawTime - now;
                const hours = Math.floor(diff / 3600000);
                const mins = Math.floor((diff % 3600000) / 60000);
                timeLeft = `${hours}h ${mins}p`;
                nextDraw = 'XSHCM (16:15)';
            } else if (hour < 18 || (hour === 18 && minute < 15)) {
                const drawTime = new Date(now);
                drawTime.setHours(18, 15, 0);
                const diff = drawTime - now;
                const hours = Math.floor(diff / 3600000);
                const mins = Math.floor((diff % 3600000) / 60000);
                timeLeft = `${hours}h ${mins}p`;
                nextDraw = 'XSMB (18:15)';
            } else {
                nextDraw = 'ƒê√£ quay xong h√¥m nay';
                timeLeft = 'Ch·ªù ng√†y mai';
            }
            
            document.getElementById('countdown').innerHTML = 
                `‚è∞ Quay s·ªë ti·∫øp theo: <strong>${nextDraw}</strong> - C√≤n <strong>${timeLeft}</strong>`;
        }

        // ==================== PARSER HTML ====================
        
        // Parser cho xskt.com.vn
        function parseXSKT(html, region) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const result = { date: '', prizes: {}, source: 'xskt.com.vn' };
            
            try {
                // L·∫•y ng√†y
                const dateEl = doc.querySelector('.ngay, .title-kqxs, h1');
                result.date = dateEl ? dateEl.textContent.trim() : '';
                
                if (region === 'hcm') {
                    // Parse XSHCM t·ª´ xskt.com.vn
                    const rows = doc.querySelectorAll('table.kqxs tr, table.box_kqxs tr, .box-kqxs-content tr');
                    
                    rows.forEach(row => {
                        const th = row.querySelector('th, td:first-child');
                        const td = row.querySelector('td:last-child, td.giai');
                        if (!th || !td) return;
                        
                        const label = th.textContent.trim().toLowerCase();
                        const numbers = [];
                        
                        td.querySelectorAll('span, em, div.dayso').forEach(span => {
                            const num = span.textContent.trim().replace(/\D/g, '');
                            if (num) numbers.push(num);
                        });
                        
                        // N·∫øu kh√¥ng c√≥ span, l·∫•y text tr·ª±c ti·∫øp
                        if (numbers.length === 0) {
                            const text = td.textContent.trim();
                            const matches = text.match(/\d+/g);
                            if (matches) numbers.push(...matches);
                        }
                        
                        if (label.includes('ƒë·∫∑c bi·ªát') || label.includes('ƒëb') || label === 'db') {
                            result.prizes.db = numbers;
                        } else if (label.includes('nh·∫•t') || label === 'g1') {
                            result.prizes.nhat = numbers;
                        } else if (label.includes('nh√¨') || label === 'g2') {
                            result.prizes.nhi = numbers;
                        } else if (label.includes('ba') || label === 'g3') {
                            result.prizes.ba = numbers;
                        } else if (label.includes('t∆∞') || label === 'g4') {
                            result.prizes.tu = numbers;
                        } else if (label.includes('nƒÉm') || label === 'g5') {
                            result.prizes.nam = numbers;
                        } else if (label.includes('s√°u') || label === 'g6') {
                            result.prizes.sau = numbers;
                        } else if (label.includes('b·∫£y') || label === 'g7') {
                            result.prizes.bay = numbers;
                        } else if (label.includes('t√°m') || label === 'g8') {
                            result.prizes.tam = numbers;
                        }
                    });
                } else {
                    // Parse XSMB
                    const rows = doc.querySelectorAll('table.kqxs tr, table.box_kqxs tr');
                    rows.forEach(row => {
                        const th = row.querySelector('th, td:first-child');
                        const td = row.querySelector('td:last-child');
                        if (!th || !td) return;
                        
                        const label = th.textContent.trim().toLowerCase();
                        const numbers = [];
                        
                        td.querySelectorAll('span, em').forEach(span => {
                            const num = span.textContent.trim().replace(/\D/g, '');
                            if (num) numbers.push(num);
                        });
                        
                        if (numbers.length === 0) {
                            const matches = td.textContent.match(/\d+/g);
                            if (matches) numbers.push(...matches);
                        }
                        
                        if (label.includes('ƒë·∫∑c bi·ªát') || label.includes('ƒëb')) {
                            result.prizes.db = numbers;
                        } else if (label.includes('nh·∫•t')) {
                            result.prizes.nhat = numbers;
                        } else if (label.includes('nh√¨')) {
                            result.prizes.nhi = numbers;
                        } else if (label.includes('ba')) {
                            result.prizes.ba = numbers;
                        } else if (label.includes('t∆∞')) {
                            result.prizes.tu = numbers;
                        } else if (label.includes('nƒÉm')) {
                            result.prizes.nam = numbers;
                        } else if (label.includes('s√°u')) {
                            result.prizes.sau = numbers;
                        } else if (label.includes('b·∫£y')) {
                            result.prizes.bay = numbers;
                        }
                    });
                }
            } catch (e) {
                console.error('Parse XSKT error:', e);
            }
            
            return result;
        }
        
        // Parser cho xoso.com.vn
        function parseXoSo(html, region) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const result = { date: '', prizes: {}, source: 'xoso.com.vn' };
            
            try {
                // L·∫•y ng√†y
                const dateEl = doc.querySelector('.title-kqxs, .ngay-quay, h1');
                result.date = dateEl ? dateEl.textContent.trim() : '';
                
                // Parse b·∫£ng k·∫øt qu·∫£
                const rows = doc.querySelectorAll('.box-kqxs table tr, table.kqxs tr');
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 2) return;
                    
                    const label = cells[0].textContent.trim().toLowerCase();
                    const numbers = [];
                    
                    cells[1].querySelectorAll('span, em, a').forEach(el => {
                        const num = el.textContent.trim().replace(/\D/g, '');
                        if (num && num.length >= 2) numbers.push(num);
                    });
                    
                    if (numbers.length === 0) {
                        const matches = cells[1].textContent.match(/\d{2,}/g);
                        if (matches) numbers.push(...matches);
                    }
                    
                    if (label.includes('ƒë·∫∑c bi·ªát') || label.includes('ƒëb')) {
                        result.prizes.db = numbers;
                    } else if (label.includes('nh·∫•t')) {
                        result.prizes.nhat = numbers;
                    } else if (label.includes('nh√¨')) {
                        result.prizes.nhi = numbers;
                    } else if (label.includes('ba')) {
                        result.prizes.ba = numbers;
                    } else if (label.includes('t∆∞')) {
                        result.prizes.tu = numbers;
                    } else if (label.includes('nƒÉm')) {
                        result.prizes.nam = numbers;
                    } else if (label.includes('s√°u')) {
                        result.prizes.sau = numbers;
                    } else if (label.includes('b·∫£y')) {
                        result.prizes.bay = numbers;
                    } else if (label.includes('t√°m')) {
                        result.prizes.tam = numbers;
                    }
                });
            } catch (e) {
                console.error('Parse XoSo error:', e);
            }
            
            return result;
        }
        
        // Parser cho minhngoc.net.vn
        function parseMinhNgoc(html, region) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const result = { date: '', prizes: {}, source: 'minhngoc.net.vn' };
            
            try {
                // L·∫•y ng√†y
                const dateEl = doc.querySelector('.title, .ngay, h1, .box-title');
                result.date = dateEl ? dateEl.textContent.trim() : '';
                
                // Parse b·∫£ng k·∫øt qu·∫£ - Minh Ng·ªçc c√≥ c·∫•u tr√∫c ri√™ng
                const table = doc.querySelector('table.bkqtinhminh, table.box_kqxs, table.kqxs');
                if (table) {
                    const rows = table.querySelectorAll('tr');
                    
                    rows.forEach(row => {
                        const th = row.querySelector('th, td.giai');
                        const td = row.querySelector('td:not(.giai), td:last-child');
                        if (!th || !td) return;
                        
                        const label = th.textContent.trim().toLowerCase();
                        const numbers = [];
                        
                        td.querySelectorAll('span, em, div').forEach(el => {
                            const num = el.textContent.trim().replace(/\D/g, '');
                            if (num && num.length >= 2) numbers.push(num);
                        });
                        
                        if (numbers.length === 0) {
                            const matches = td.textContent.match(/\d{2,}/g);
                            if (matches) numbers.push(...matches);
                        }
                        
                        if (label.includes('ƒë·∫∑c bi·ªát') || label.includes('ƒëb') || label === 'ƒëb') {
                            result.prizes.db = numbers;
                        } else if (label.includes('nh·∫•t') || label.includes('g.1') || label === '1') {
                            result.prizes.nhat = numbers;
                        } else if (label.includes('nh√¨') || label.includes('g.2') || label === '2') {
                            result.prizes.nhi = numbers;
                        } else if (label.includes('ba') || label.includes('g.3') || label === '3') {
                            result.prizes.ba = numbers;
                        } else if (label.includes('t∆∞') || label.includes('g.4') || label === '4') {
                            result.prizes.tu = numbers;
                        } else if (label.includes('nƒÉm') || label.includes('g.5') || label === '5') {
                            result.prizes.nam = numbers;
                        } else if (label.includes('s√°u') || label.includes('g.6') || label === '6') {
                            result.prizes.sau = numbers;
                        } else if (label.includes('b·∫£y') || label.includes('g.7') || label === '7') {
                            result.prizes.bay = numbers;
                        } else if (label.includes('t√°m') || label.includes('g.8') || label === '8') {
                            result.prizes.tam = numbers;
                        }
                    });
                }
            } catch (e) {
                console.error('Parse MinhNgoc error:', e);
            }
            
            return result;
        }

        // Ch·ªçn parser ph√π h·ª£p d·ª±a tr√™n URL
        function parseHTML(html, url, region) {
            if (url.includes('xskt.com.vn')) {
                return parseXSKT(html, region);
            } else if (url.includes('xoso.com.vn')) {
                return parseXoSo(html, region);
            } else if (url.includes('minhngoc.net.vn')) {
                return parseMinhNgoc(html, region);
            }
            return null;
        }

        // Ki·ªÉm tra d·ªØ li·ªáu h·ª£p l·ªá
        function isValidData(data) {
            if (!data || !data.prizes) return false;
            // Ph·∫£i c√≥ √≠t nh·∫•t gi·∫£i ƒêB
            if (!data.prizes.db || data.prizes.db.length === 0) return false;
            // Ph·∫£i c√≥ √≠t nh·∫•t 3 gi·∫£i
            const prizeCount = Object.keys(data.prizes).filter(k => data.prizes[k] && data.prizes[k].length > 0).length;
            return prizeCount >= 3;
        }

        // ==================== FETCH D·ªÆ LI·ªÜU T·ª™ NGU·ªíN CH√çNH TH·ªêNG ====================
        
        async function fetchWithProxy(url, proxyUrl) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);
            
            try {
                const response = await fetch(proxyUrl + encodeURIComponent(url), {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                    }
                });
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    return await response.text();
                }
            } catch (e) {
                clearTimeout(timeoutId);
                throw e;
            }
            return null;
        }

        async function fetchFromOfficialSources(region) {
            const sources = CONFIG.SOURCES[region];
            const proxies = CONFIG.CORS_PROXIES;
            
            // Th·ª≠ t·ª´ng ngu·ªìn v·ªõi t·ª´ng proxy
            for (const sourceUrl of sources) {
                for (const proxyUrl of proxies) {
                    try {
                        console.log(`üîç ƒêang th·ª≠: ${sourceUrl} qua ${proxyUrl}`);
                        const html = await fetchWithProxy(sourceUrl, proxyUrl);
                        
                        if (html && html.length > 1000) {
                            const data = parseHTML(html, sourceUrl, region);
                            
                            if (isValidData(data)) {
                                console.log(`‚úÖ L·∫•y th√†nh c√¥ng t·ª´ ${sourceUrl}`);
                                data.sourceUrl = sourceUrl;
                                return data;
                            }
                        }
                    } catch (e) {
                        console.log(`‚ùå L·ªói v·ªõi ${sourceUrl}: ${e.message}`);
                    }
                }
            }
            
            return null;
        }

        // L·∫•y d·ªØ li·ªáu t·ª´ localStorage
        function getStoredData(region) {
            const stored = localStorage.getItem(`lottery_${region}`);
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    const storedDate = new Date(data.timestamp);
                    const now = new Date();
                    
                    // Ki·ªÉm tra d·ªØ li·ªáu c√≤n h·ª£p l·ªá (trong ng√†y v√† ch∆∞a qu√° 30 ph√∫t)
                    const diffMinutes = (now - storedDate) / 60000;
                    if (storedDate.toDateString() === now.toDateString() && diffMinutes < 30) {
                        return data;
                    }
                } catch (e) {
                    console.error('Error parsing stored data:', e);
                }
            }
            return null;
        }

        // L∆∞u d·ªØ li·ªáu v√†o localStorage
        function storeData(region, data) {
            const storeObj = {
                ...data,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem(`lottery_${region}`, JSON.stringify(storeObj));
        }

        // T·∫°o d·ªØ li·ªáu m·∫´u (fallback)
        function generateFallbackData(region) {
            const now = new Date();
            const dateStr = now.toLocaleDateString('vi-VN', { 
                weekday: 'long', 
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });

            const gen = (len) => {
                let r = '';
                for (let i = 0; i < len; i++) r += Math.floor(Math.random() * 10);
                return r;
            };

            if (region === 'hcm') {
                return {
                    date: `X·ªï s·ªë TP.HCM - ${dateStr}`,
                    prizes: {
                        db: [gen(6)], nhat: [gen(5)], nhi: [gen(5), gen(5)],
                        ba: [gen(5), gen(5), gen(5), gen(5)],
                        tu: [gen(4), gen(4), gen(4), gen(4), gen(4), gen(4), gen(4)],
                        nam: [gen(4)], sau: [gen(4), gen(4), gen(4)],
                        bay: [gen(2), gen(2)], tam: [gen(2)]
                    },
                    source: 'Demo',
                    isDemo: true
                };
            } else {
                return {
                    date: `X·ªï s·ªë Mi·ªÅn B·∫Øc - ${dateStr}`,
                    prizes: {
                        db: [gen(5)], nhat: [gen(5)], nhi: [gen(5), gen(5)],
                        ba: [gen(5), gen(5), gen(5), gen(5), gen(5), gen(5)],
                        tu: [gen(4), gen(4), gen(4), gen(4)],
                        nam: [gen(4), gen(4), gen(4), gen(4), gen(4), gen(4)],
                        sau: [gen(3), gen(3), gen(3)],
                        bay: [gen(2), gen(2), gen(2), gen(2)]
                    },
                    source: 'Demo',
                    isDemo: true
                };
            }
        }

        // H√†m ch√≠nh fetch k·∫øt qu·∫£ x·ªï s·ªë
        async function fetchLotteryData(region, forceRefresh = false) {
            const statusEl = document.getElementById(`${region}-status`);
            statusEl.textContent = '‚è≥ ƒêang t·∫£i...';
            
            try {
                // Ki·ªÉm tra cache tr∆∞·ªõc (n·∫øu kh√¥ng force refresh)
                if (!forceRefresh) {
                    const cached = getStoredData(region);
                    if (cached && isValidData(cached)) {
                        lotteryData[region] = cached;
                        renderLotteryTable(region, cached);
                        statusEl.textContent = '‚úÖ ' + (cached.source || 'Cached');
                        lotteryData.lastUpdate = new Date(cached.timestamp);
                        updateLastUpdateInfo();
                        return;
                    }
                }
                
                // Fetch t·ª´ ngu·ªìn ch√≠nh th·ªëng
                const data = await fetchFromOfficialSources(region);
                
                if (data && isValidData(data)) {
                    lotteryData[region] = data;
                    storeData(region, data);
                    renderLotteryTable(region, data);
                    statusEl.textContent = 'üî¥ ' + (data.source || 'LIVE');
                    lotteryData.lastUpdate = new Date();
                    updateLastUpdateInfo();
                    console.log(`‚úÖ ${region.toUpperCase()}: L·∫•y d·ªØ li·ªáu th√†nh c√¥ng t·ª´ ${data.source}`);
                    return;
                }
                
                // Fallback: d√πng d·ªØ li·ªáu m·∫´u
                console.log(`‚ö†Ô∏è ${region.toUpperCase()}: Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu th·ª±c, d√πng demo`);
                const fallback = generateFallbackData(region);
                lotteryData[region] = fallback;
                renderLotteryTable(region, fallback);
                statusEl.textContent = 'üü° Demo';
                
            } catch (error) {
                console.error(`Error fetching ${region}:`, error);
                const fallback = generateFallbackData(region);
                lotteryData[region] = fallback;
                renderLotteryTable(region, fallback);
                statusEl.textContent = 'üü° Demo';
            }
            
            lotteryData.lastUpdate = new Date();
            updateLastUpdateInfo();
        }

        function updateLastUpdateInfo() {
            if (lotteryData.lastUpdate) {
                const timeStr = lotteryData.lastUpdate.toLocaleTimeString('vi-VN');
                let sourceInfo = '';
                if (lotteryData.hcm && lotteryData.hcm.source) {
                    sourceInfo = ` | Ngu·ªìn: ${lotteryData.hcm.source}`;
                }
                document.getElementById('updateInfo').innerHTML = 
                    `C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <strong>${timeStr}</strong>${sourceInfo}`;
            }
        }

        function renderLotteryTable(region, data) {
            const tbody = document.getElementById(`${region}-body`);
            const dateEl = document.getElementById(`${region}-date`);
            
            let dateText = data.date || 'K·∫øt qu·∫£ m·ªõi nh·∫•t';
            if (data.isDemo) {
                dateText += ' <span style="background:#f39c12;color:white;padding:2px 8px;border-radius:5px;font-size:10px;">DEMO</span>';
            }
            dateEl.innerHTML = dateText;
            
            let html = '';
            const prizeOrder = ['db', 'nhat', 'nhi', 'ba', 'tu', 'nam', 'sau', 'bay', 'tam'];
            
            prizeOrder.forEach(prize => {
                if (data.prizes && data.prizes[prize] && data.prizes[prize].length > 0) {
                    const isSpecial = prize === 'db';
                    html += `<tr class="${isSpecial ? 'special' : ''}">`;
                    html += `<th>${prizeLabels[prize]}</th>`;
                    html += `<td><span class="numbers">`;
                    
                    data.prizes[prize].forEach(num => {
                        html += `<span data-number="${num}" data-region="${region}">${num}</span>`;
                    });
                    
                    html += `</span></td></tr>`;
                }
            });
            
            tbody.innerHTML = html || '<tr><td colspan="2" class="error-msg">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        }

        // ==================== L√ÄM M·ªöI ====================
        async function refreshAllData() {
            const btn = document.querySelector('.refresh-btn');
            btn.classList.add('loading');
            btn.textContent = '‚è≥ ƒêang c·∫≠p nh·∫≠t t·ª´ ngu·ªìn ch√≠nh th·ªëng...';
            
            // X√≥a cache
            localStorage.removeItem('lottery_hcm');
            localStorage.removeItem('lottery_mb');
            
            await Promise.all([
                fetchLotteryData('hcm', true),
                fetchLotteryData('mb', true)
            ]);
            
            btn.classList.remove('loading');
            btn.textContent = 'üîÑ L√†m m·ªõi k·∫øt qu·∫£';
        }

        // ==================== KI·ªÇM TRA S·ªê ====================
        function checkNumber() {
            const input = document.getElementById('numberInput').value.trim();
            const region = document.querySelector('input[name="region"]:checked').value;
            
            if (input.length < 2) {
                alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t 2 s·ªë!');
                return;
            }

            const data = lotteryData[region];
            if (!data || !data.prizes) {
                alert('Ch∆∞a c√≥ d·ªØ li·ªáu x·ªï s·ªë. Vui l√≤ng ƒë·ª£i ho·∫∑c l√†m m·ªõi!');
                return;
            }

            const regionName = region === 'hcm' ? 'X·ªï s·ªë H·ªì Ch√≠ Minh' : 'X·ªï s·ªë Mi·ªÅn B·∫Øc';
            let wonPrizes = [];

            // X√≥a highlight c≈©
            document.querySelectorAll('.numbers span.highlight').forEach(el => {
                el.classList.remove('highlight');
            });

            // Ki·ªÉm tra t·ª´ng gi·∫£i
            for (let [prizeKey, numbers] of Object.entries(data.prizes)) {
                if (!numbers) continue;
                
                for (let num of numbers) {
                    const checkLength = num.length;
                    const inputSuffix = input.slice(-checkLength);
                    
                    if (inputSuffix === num || num.endsWith(input)) {
                        wonPrizes.push({
                            prize: prizeKey,
                            number: num,
                            name: prizeLabels[prizeKey],
                            amount: prizeAmounts[prizeKey]
                        });

                        // Highlight s·ªë tr√∫ng
                        document.querySelectorAll(`span[data-number="${num}"][data-region="${region}"]`).forEach(el => {
                            el.classList.add('highlight');
                        });
                    }
                }
            }

            // Ki·ªÉm tra gi·∫£i an ·ªßi (5 s·ªë cu·ªëi tr√πng v·ªõi ƒêB nh∆∞ng s·ªë ƒë·∫ßu kh√°c)
            if (input.length >= 6 && data.prizes.db && data.prizes.db[0]) {
                const dbNumber = data.prizes.db[0];
                if (dbNumber.length >= 5) {
                    const last5DB = dbNumber.slice(-5);
                    const last5Input = input.slice(-5);
                    const firstDigitDB = dbNumber[0];
                    const firstDigitInput = input[0];
                    
                    if (last5Input === last5DB && firstDigitInput !== firstDigitDB) {
                        // Ki·ªÉm tra xem ch∆∞a tr√∫ng ƒêB
                        if (!wonPrizes.some(p => p.prize === 'db')) {
                            wonPrizes.push({
                                prize: 'anui',
                                number: input,
                                name: 'Gi·∫£i An ·ª¶i',
                                amount: prizeAmounts.anui
                            });
                        }
                    }
                }
            }

            showResult(wonPrizes, input, regionName);
        }

        function showResult(wonPrizes, inputNumber, regionName) {
            const modal = document.getElementById('resultModal');
            const modalContent = document.getElementById('modalContent');
            const emoji = document.getElementById('emoji');
            const title = document.getElementById('resultTitle');
            const message = document.getElementById('resultMessage');
            const prizeInfo = document.getElementById('prizeInfo');
            const agencyNote = document.getElementById('agencyNote');

            if (wonPrizes.length > 0) {
                modalContent.className = 'modal-content win';
                emoji.textContent = 'üéâüèÜüéä';
                title.textContent = 'CH√öC M·ª™NG B·∫†N ƒê√É TR√öNG TH∆Ø·ªûNG!';
                message.innerHTML = `S·ªë <strong style="font-size: 24px; color: #e74c3c;">${inputNumber}</strong> ƒë√£ tr√∫ng ${regionName}!`;
                
                let prizeHtml = '';
                wonPrizes.forEach(p => {
                    prizeHtml += `<div style="margin: 10px 0;">üèÖ <strong>${p.name}</strong><br>üí∞ ${p.amount}</div>`;
                });
                prizeInfo.innerHTML = prizeHtml;
                prizeInfo.style.display = 'block';
                agencyNote.style.display = 'block';
                
                createConfetti();
            } else {
                modalContent.className = 'modal-content lose';
                emoji.textContent = 'üò¢üí™üçÄ';
                title.textContent = 'CH√öC B·∫†N MAY M·∫ÆN L·∫¶N SAU!';
                message.innerHTML = `
                    R·∫•t ti·∫øc, s·ªë <strong style="font-size: 20px;">${inputNumber}</strong> ch∆∞a tr√∫ng gi·∫£i n√†o trong ${regionName}.<br><br>
                    üçÄ ƒê·ª´ng n·∫£n ch√≠! H√£y ti·∫øp t·ª•c th·ª≠ v·∫≠n may!<br>
                    üìÖ K·∫øt qu·∫£ x·ªï s·ªë ƒë∆∞·ª£c quay h√†ng ng√†y.<br>
                    üéØ Th·ª≠ d√≤ v·ªõi s·ªë kh√°c ho·∫∑c v√πng kh√°c!
                `;
                prizeInfo.style.display = 'none';
                agencyNote.style.display = 'none';
            }

            modal.classList.add('show');
        }

        function closeModal() {
            const modal = document.getElementById('resultModal');
            modal.classList.remove('show');
            document.querySelectorAll('.confetti').forEach(c => c.remove());
        }

        function createConfetti() {
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e91e63', '#00bcd4'];
            for (let i = 0; i < 150; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                    confetti.style.width = (Math.random() * 10 + 5) + 'px';
                    confetti.style.height = confetti.style.width;
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 20);
            }
        }

        // ==================== EVENT LISTENERS ====================
        document.getElementById('resultModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('numberInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') checkNumber();
        });

        // Escape key to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModal();
        });

        // ==================== KH·ªûI ƒê·ªòNG ====================
        function init() {
            console.log('üé∞ Kh·ªüi ƒë·ªông h·ªá th·ªëng x·ªï s·ªë tr·ª±c tuy·∫øn...');
            
            // C·∫≠p nh·∫≠t ƒë·ªìng h·ªì
            updateClock();
            setInterval(updateClock, 1000);
            
            // Fetch d·ªØ li·ªáu ban ƒë·∫ßu
            fetchLotteryData('hcm');
            fetchLotteryData('mb');
            
            // T·ª± ƒë·ªông c·∫≠p nh·∫≠t m·ªói 5 ph√∫t
            setInterval(() => {
                console.log('üîÑ T·ª± ƒë·ªông c·∫≠p nh·∫≠t k·∫øt qu·∫£...');
                fetchLotteryData('hcm');
                fetchLotteryData('mb');
            }, CONFIG.REFRESH_INTERVAL);
            
            console.log('‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng!');
        }

        // Kh·ªüi ƒë·ªông khi trang load xong
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
